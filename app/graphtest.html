<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>SSB JSON-stat Example (D3.js - Multiple Lines)</title>
    <!-- Load d3.js from CDN (version 7 here, but you can also use other versions) -->
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <style>
        /* Some basic styling for the axes text, etc. */
        .axis text {
            font-family: sans-serif;
            font-size: 12px;
        }
        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }
        .legend {
            font-family: sans-serif;
            font-size: 12px;
        }
        .legend-color-box {
            width: 12px;
            height: 12px;
            display: inline-block;
            margin-right: 4px;
        }
    </style>
</head>
<body>

<script>
    // 1. JSON-stat response with the FULL "value" array:
    const jsonStat = {
        "version": "2.0",
        "class": "dataset",
        "label":"03516: Dødsulykker, etter skadested, aktivitet, statistikkvariabel og år",
        "source":"Statistisk sentralbyrå",
        "updated":"2010-12-03T09:00:00Z",
        "note": [
            "ICD-10 kodene V01 - X59. Norske steds- og aktivitetskoder, se sidene 988 - 998 i norsk utgave av ICD-10. Statens helsetilsyn 1998."
        ],
        "id": ["Skadested","Aktivitet","ContentsCode","Tid"],
        "size": [10,5,1,14],
        "dimension": {
            "Skadested": {
                "label":"skadested",
                "category":{
                    "index":{
                        "01":0,"02":1,"03":2,"04":3,"05":4,"06":5,"07":6,"08":7,"09":8,"10":9
                    },
                    "label":{
                        "01":"Bolig og boligområde",
                        "02":"Trafikkulykker",
                        "03":"Annen ulykke på gate/vei (ikke trafikkulykke)",
                        "04":"Barnehage/lekeplass",
                        "05":"Skole/skolegård",
                        "06":"Sykehus, helse- og pleieinstitusjon",
                        "07":"Idrettsanlegg",
                        "08":"Friluft, hav, sjø og vann",
                        "09":"Annet oppgitt sted",
                        "10":"Ukjent skadested"
                    },
                    "extension":{"elimination":true,"show":"value"}
                }
            },
            "Aktivitet": {
                "label":"aktivitet",
                "category":{
                    "index":{
                        "01":0,"02":1,"03":2,"04":3,"05":4
                    },
                    "label":{
                        "01":"Inntektsgivende arbeid",
                        "02":"Utdanning, verneplikt",
                        "03":"Idrett, sport, mosjon",
                        "04":"Annen aktivitet",
                        "05":"Ukjent aktivitet"
                    },
                    "extension":{"elimination":true,"show":"value"}
                }
            },
            "ContentsCode": {
                "label":"statistikkvariabel",
                "category":{
                    "index":{"Dodsfall":0},
                    "label":{"Dodsfall":"Dødsfall"},
                    "unit":{"Dodsfall":{"base":"personer","decimals":0}}
                },
                "extension":{
                    "elimination":false,
                    "refperiod":{"Dodsfall":"31.12."},
                    "show":"value"
                }
            },
            "Tid": {
                "label":"år",
                "category":{
                    "index":{
                        "1996":0,"1997":1,"1998":2,"1999":3,"2000":4,"2001":5,"2002":6,
                        "2003":7,"2004":8,"2005":9,"2006":10,"2007":11,"2008":12,"2009":13
                    },
                    "label":{
                        "1996":"1996","1997":"1997","1998":"1998","1999":"1999",
                        "2000":"2000","2001":"2001","2002":"2002","2003":"2003",
                        "2004":"2004","2005":"2005","2006":"2006","2007":"2007",
                        "2008":"2008","2009":"2009"
                    }
                },
                "extension":{"elimination":false,"show":"code"}
            }
        },
        "value": [
            /* All 700 values EXACTLY as returned from SSB: */
            2,0,0,4,9,5,2,8,6,5,2,0,3,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,
            0,0,0,0,0,0,31,63,51,37,46,73,57,48,10,3,2,3,3,2,296,263,250,319,266,
            288,312,440,543,391,438,488,524,530,17,12,9,14,8,8,4,3,3,3,1,2,5,5,0,1,
            1,1,3,0,0,0,0,0,0,0,0,0,1,1,1,1,0,1,0,0,0,0,0,0,0,0,120,206,203,152,
            234,245,316,233,261,216,136,92,85,163,135,95,157,143,98,35,7,57,13,19,
            83,130,166,46,1,0,0,1,1,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,4,6,1,3,2,5,0,2,1,0,0,3,4,2,4,2,0,3,2,2,
            3,6,4,3,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,3,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,
            0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            1,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,5,15,12,16,14,18,29,12,2,1,1,0,0,0,44,42,44,
            44,47,44,44,49,70,62,57,42,74,61,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
            0,0,0,0,0,0,0,0,0,1,1,0,0,0,1,1,0,0,1,0,0,1,1,3,0,0,1,1,1,0,0,0,2,0,0,
            0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,11,10,6,16,13,10,7,20,2,7,8,10,8,12,0,0,
            0,0,0,0,0,0,0,1,2,0,0,0,7,6,4,10,4,3,2,3,3,3,6,1,3,11,23,48,30,52,52,
            55,81,51,113,17,25,17,10,6,73,77,74,77,74,79,94,117,138,108,104,100,75,
            76,20,25,27,19,24,10,13,5,13,19,11,10,19,14,0,1,0,0,1,0,0,0,0,0,0,2,0,0,
            1,1,2,0,0,0,0,0,0,0,0,0,0,2,14,10,18,9,28,14,10,13,5,3,8,2,3,4,49,34,34,
            19,45,31,26,70,70,65,226,92,103,147,7,10,7,11,3,5,2,1,4,3,1,3,4,3,0,0,0,
            0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,8,16,11,9,6,5,5,5,1,4,
            2,0,0,0,754,731,733,815,724,728,694,714,670,866,657,827,786,861
        ]
    };

    // 2. Extract dimension info:
    const dim = jsonStat.dimension;
    const size = jsonStat.size;  // [10, 5, 1, 14]

    const skadestedIndex = dim.Skadested.category.index;
    const aktivitetIndex = dim.Aktivitet.category.index;
    const tidIndex       = dim.Tid.category.index;

    // We fix Aktivitet to "Inntektsgivende arbeid" (which is "01")
    // and the measure (ContentsCode) is only 1 => index 0
    const iAktivitet = aktivitetIndex["01"];
    const iContents  = 0;

    // 3. Build one data series per "Skadested"
    //  - We'll get an array of [ [skadeKey, skadeIdx], ... ] for each skadested
    const skadestedCategories = Object.entries(skadestedIndex);
    // e.g. [["01",0], ["02",1], ["03",2], ...]

    const allSeries = skadestedCategories.map(([skadeKey, skadeIdx]) => {
        // Build an array of { year, value } objects for this Skadested across all years
        const thisSeriesData = Object.entries(dim.Tid.category.index).map(([yearStr, iTid]) => {
            const indexInValue =
                skadeIdx * (size[1] * size[2] * size[3]) +
                iAktivitet * (size[2] * size[3]) +
                iContents  * size[3] +
                iTid;
            return {
                year: +yearStr,  // convert "1996" -> number
                value: jsonStat.value[indexInValue]
            };
        });

        return {
            skadestedCode: skadeKey,     // e.g. "01" or "02"
            skadestedName: dim.Skadested.category.label[skadeKey],
            data: thisSeriesData
        };
    });

    // Flatten all data to figure out overall x- and y-domain
    const allData = allSeries.flatMap(s => s.data);

    // 4. Use d3 to render multiple lines in one chart

    // Set up dimensions for the SVG
    const margin = { top: 40, right: 150, bottom: 40, left: 50 },
        width  = 800 - margin.left - margin.right,
        height = 400 - margin.top  - margin.bottom;

    // Create an SVG and a grouping element for our chart
    const svg = d3.select("body")
        .append("svg")
        .attr("width",  width  + margin.left + margin.right)
        .attr("height", height + margin.top  + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

    // Define scales
    const x = d3.scaleLinear()
        .domain(d3.extent(allData, d => d.year))  // e.g. [1996, 2009]
        .range([0, width]);

    const y = d3.scaleLinear()
        .domain([0, d3.max(allData, d => d.value)]).nice()
        .range([height, 0]);

    // Define a color scale for different Skadested lines
    const color = d3.scaleOrdinal(d3.schemeCategory10);

    // Define the line generator (no fill here, just stroke)
    const lineGenerator = d3.line()
        .x(d => x(d.year))
        .y(d => y(d.value))
        .curve(d3.curveMonotoneX);

    // For each skadested series, draw a line
    allSeries.forEach(series => {
        svg.append("path")
            .datum(series.data)
            .attr("fill", "none")
            .attr("stroke", color(series.skadestedCode))
            .attr("stroke-width", 2)
            .attr("d", lineGenerator);
    });

    // Create axes
    svg.append("g")
        .attr("class", "x axis")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x).tickFormat(d3.format("d")));  // "d" => integer year

    svg.append("g")
        .attr("class", "y axis")
        .call(d3.axisLeft(y));

    // Optional: Add a chart title
    svg.append("text")
        .attr("x", 0)
        .attr("y", -10)
        .attr("font-weight", "bold")
        .text("Dødsfall per Skadested (Aktivitet: Inntektsgivende arbeid)");

    // ---------------------------------------------------------------------
    // Add a simple legend on the right side
    // ---------------------------------------------------------------------
    const legend = svg.selectAll(".legend")
        .data(allSeries)
        .enter()
        .append("g")
        .attr("class", "legend")
        .attr("transform", (d, i) => {
            // Place legend items in a vertical list
            return `translate(${width + 20}, ${i * 20})`;
        });

    legend.append("rect")
        .attr("class", "legend-color-box")
        .attr("width", 12)
        .attr("height", 12)
        .attr("fill", d => color(d.skadestedCode));

    legend.append("text")
        .attr("x", 20)
        .attr("y", 10)
        .text(d => d.skadestedName);
</script>

</body>
</html>
